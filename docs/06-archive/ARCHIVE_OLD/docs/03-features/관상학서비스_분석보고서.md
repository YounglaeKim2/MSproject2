# 관상학 서비스 분석 보고서

> **분석일**: 2025-07-30 11:00  
> **상태**: ✅ 분석 완료  
> **통합 방법**: Docker Compose 권장  

---

## 🎯 프로젝트 개요

**동료가 제공한 완성형 관상학 서비스**
- **목적**: 얼굴 이미지 기반 전통 관상학 분석
- **기술**: AI + 전통 관상학 + RAG(검색증강생성)
- **포트**: 백엔드 8001, 프론트엔드 3001, DB 5433

---

## 🏗️ 서비스 아키텍처

### **마이크로서비스 구성**
```
Physiognomy Service
├── 📡 Backend (FastAPI + AI)      → 포트 8001
├── 🖥️ Frontend (React + TS)       → 포트 3001  
└── 🗄️ Database (PostgreSQL)      → 포트 5433
```

### **MSProject2 전체 구성에서의 위치**
```
MSProject2 SAJU 완전체
├── Main App (4000)               ✅ 완성
├── SAJU Service (8000/3000)      ✅ 완성
├── Compatibility (8002/3002)     ✅ 완성
└── Physiognomy (8001/3001)       🆕 추가 예정
```

---

## 🤖 AI 분석 파이프라인 (4단계)

### **1단계: 얼굴 인식** (`face_landmarker.py`)
**기술**: MediaPipe FaceMesh
```python
# 468개 얼굴 랜드마크 추출
with mp_face_mesh.FaceMesh(
    static_image_mode=True,
    max_num_faces=1,
    refine_landmarks=True,
    min_detection_confidence=0.5
) as face_mesh:
    results = face_mesh.process(image)
```

**결과**: 얼굴의 모든 주요 점 좌표 (눈, 코, 입, 이마, 턱선)

### **2단계: 기하학적 계산** (`geometry_calculator.py`)
**30+ 비율 및 거리 계산**

| 분석 영역 | 주요 계산 항목 | 관상학적 의미 |
|----------|---------------|-------------|
| **얼굴형** | 가로세로 비율 | 성격 유형 판단 |
| **이마** | 전체 얼굴 대비 비율 | 지적 능력, 창의성 |
| **눈** | 크기, 간격, 각도 | 감정 표현, 직관력 |
| **코** | 높이, 너비, 각도 | 의지력, 리더십 |
| **입** | 두께, 너비, 각도 | 표현력, 사교성 |
| **턱** | 길이, 각도, 폭 | 의지력, 지구력 |

### **3단계: 관상학 규칙 엔진** (`rule_engine.py`)
**수치 → 관상학적 해석 매핑**

```python
# 얼굴형 분석 예시
if metrics['face_aspect_ratio'] < 1.05:
    interpretations.append('FACE_SHAPE_ROUND')    # 원형 → 온화, 사교적
elif metrics['face_aspect_ratio'] > 1.2:
    interpretations.append('FACE_SHAPE_LONG')     # 긴형 → 사색적, 신중
else:
    interpretations.append('FACE_SHAPE_BALANCED') # 균형형 → 조화로움
```

### **4단계: AI 보고서 생성** (`report_generator.py`)
**RAG(검색증강생성) 시스템**

```python
# 지식베이스: 관상로직.txt (전통 관상학 이론서)
knowledge_base = load_knowledge_base("관상로직.txt")

# 벡터 검색으로 관련 이론 찾기
relevant_theory = vector_search(interpretations, knowledge_base)

# Gemini AI로 개인화된 보고서 생성
personalized_report = gemini_ai.generate(
    prompt=f"다음 관상학적 특징을 바탕으로 개인 분석 보고서 작성: {interpretations}",
    context=relevant_theory
)
```

---

## 💾 데이터베이스 설계

### **AnalysisResult 테이블**
```sql
CREATE TABLE analysis_results (
    id INTEGER PRIMARY KEY,
    original_filename STRING,    -- 업로드 파일명  
    image_path STRING,          -- 저장된 이미지 경로
    report TEXT,                -- 생성된 관상 분석 보고서
    created_at DATETIME         -- 분석 시각
);
```

**기능**:
- 분석 결과 영구 저장
- 분석 히스토리 조회
- 재분석 방지 (동일 이미지 캐싱)

---

## 🎨 프론트엔드 구성

### **React 18 + TypeScript**
```typescript
// 주요 컴포넌트
├── ImageUpload (react-dropzone)     // 드래그앤드롭 업로드
├── WebcamCapture (react-webcam)     // 실시간 촬영
├── AnalysisProgress                 // 분석 진행 상태
├── ResultDisplay                    // 보고서 출력
└── HistoryView                      // 분석 기록 조회
```

### **스타일링**
- **styled-components**: 기존 SAJU/Compatibility와 동일
- **반응형 디자인**: 모바일/태블릿 지원
- **포트 3001**: 기존 서비스와 충돌 없음

---

## 🔧 기술 스택 분석

### **AI/ML 라이브러리**
| 패키지 | 용도 | 크기 | 설치 복잡도 |
|--------|------|------|------------|
| **MediaPipe** | 얼굴 인식 | ~100MB | ⭐⭐⭐ |
| **OpenCV** | 이미지 처리 | ~80MB | ⭐⭐⭐ |
| **LangChain** | AI 체인 관리 | ~50MB | ⭐⭐ |
| **FAISS** | 벡터 검색 | ~30MB | ⭐⭐⭐⭐ |
| **SentenceTransformers** | 텍스트 임베딩 | ~200MB | ⭐⭐ |

### **환경 호환성**
- **Python 3.11.13**: ✅ 완벽 호환
- **Windows**: ✅ 지원 (현재 환경)
- **의존성**: 복잡함 (5개 AI 라이브러리)

---

## 🚀 통합 방안

### **Option 1: Docker Compose** (🏆 **권장**)

**장점**:
- 한 번에 모든 의존성 해결
- 환경 독립성 보장
- 포트 자동 설정
- 3개 서비스 (백엔드/프론트엔드/DB) 동시 실행

**실행 방법**:
```bash
cd Physiognomy
docker-compose up
```

**접속**: http://localhost:3001

### **Option 2: 수동 설치**

**의존성 설치** (5-10분):
```bash
cd Physiognomy/backend
pip install -r requirements.txt    # AI 라이브러리 설치

cd ../frontend  
npm install                        # React 패키지 설치
```

**개별 실행**:
```bash
# 백엔드
python -m uvicorn app.main:app --reload --port 8001

# 프론트엔드  
PORT=3001 npm start
```

---

## 🌊 전체 처리 흐름

```
1. 사용자 이미지 업로드 (Drag & Drop / 웹캠)
   ↓
2. MediaPipe 얼굴 랜드마크 추출 (468개 점)
   ↓  
3. 기하학적 특징 계산 (30+ 비율/거리)
   ↓
4. 관상학 규칙 엔진 해석 (전통 이론 적용)
   ↓
5. RAG 지식베이스 검색 (관상로직.txt)
   ↓
6. Gemini AI 개인화 보고서 생성
   ↓
7. PostgreSQL 결과 저장
   ↓
8. React UI 결과 표시
```

---

## 📊 기존 시스템과의 통합성

### **완벽한 마이크로서비스 호환**

| 기준 | SAJU | Compatibility | Physiognomy | 호환성 |
|------|------|---------------|-------------|--------|
| **백엔드** | FastAPI | FastAPI | FastAPI | ✅ 동일 |
| **프론트엔드** | React+TS | React+TS | React+TS | ✅ 동일 |
| **스타일링** | styled-components | styled-components | styled-components | ✅ 동일 |
| **포트** | 8000/3000 | 8002/3002 | 8001/3001 | ✅ 분리 |
| **아키텍처** | 마이크로서비스 | 마이크로서비스 | 마이크로서비스 | ✅ 동일 |

### **Main App 연동**
```typescript
// Main App에 관상 분석 링크 추가
<Link to="http://localhost:3001">
  🎭 관상 분석
</Link>
```

---

## 🎯 완성 시 전체 시스템

```
MSProject2 SAJU - 완전체 (4개 서비스)
├── 🏠 Main App (4000)           - 통합 랜딩 페이지
├── 🔮 SAJU (8000/3000)          - 사주팔자 + 대운 + 세운 + AI 채팅
├── 💕 Compatibility (8002/3002)  - 궁합 분석 (사주+오행+십성)
└── 🎭 Physiognomy (8001/3001)   - 관상 분석 (AI+전통 관상학)
```

**접속 URL**:
- **통합 서비스**: http://localhost:4000
- **사주 분석**: http://localhost:3000  
- **궁합 분석**: http://localhost:3002
- **관상 분석**: http://localhost:3001

---

## 💡 추천 실행 방법

### **Docker Compose 실행** (1분 소요)
```bash
cd C:\workspace\MSproject2_SAJU\Physiognomy
docker-compose up
```

**이유**:
1. **의존성 자동 해결**: 복잡한 AI 라이브러리 걱정 없음
2. **환경 독립성**: 어떤 컴퓨터에서도 동일하게 작동
3. **포트 자동 할당**: 8001/3001 자동 설정
4. **3개 서비스 동시 실행**: 백엔드+프론트엔드+DB 한 번에

**예상 결과**:
- ✅ Backend: http://localhost:8001 (AI 관상 분석 API)
- ✅ Frontend: http://localhost:3001 (React 관상 분석 UI)  
- ✅ Database: PostgreSQL 자동 설정 및 테이블 생성

---

**📝 분석 완료**: 2025-07-30 11:00  
**🚀 다음 단계**: Docker Compose로 Physiognomy 서비스 실행  
**🎯 최종 목표**: MSProject2 SAJU 4개 서비스 완전체 달성