# 📱 모바일 앱 네트워크 연결 이슈 해결 기록

> **작업일**: 2025-08-05  
> **상태**: 진행 중 (iOS 시뮬레이터 연결 문제 잔존)

## 🔍 문제 상황

### 발생 이슈
```
LOG  🔧 API Configuration: {"apiBaseUrl": "http://192.168.219.141:8000/api/v1/saju", "platform": "ios"}
ERROR ❌ 네트워크 요청 실패: Network request failed
ERROR ❌ 네트워크 연결 실패: [AbortError: Aborted]
```

**모바일 앱에서 SAJU 백엔드 API 연결 실패**
- iOS 시뮬레이터에서 네트워크 IP로 접근 시 타임아웃 발생
- localhost 접근도 실패
- 백엔드 서버는 정상 실행 중 (`0.0.0.0:8000`)

## ✅ 완료된 해결 작업

### 1. API 설정 개선 (`AppService/FortuneApp/src/config/api.ts`)
```typescript
// 플랫폼별 호스트 IP 결정 - 모든 플랫폼에서 네트워크 IP 사용
const getApiHost = () => {
  if (!isDevelopment) return 'https://your-domain.com';
  return 'http://192.168.219.141:8000'; // 모든 플랫폼 통일
};

export const API_BASE_URL = `${getApiHost()}/api/v1/saju`;
```

### 2. 견고한 네트워크 헬퍼 구현 (`src/utils/networkHelper.ts`)
```typescript
// 재시도 로직 (최대 3회, 지수적 백오프)
export const fetchWithRetry = async (url, options, maxRetries = 3, retryDelay = 1000)

// 네트워크 진단 정보
export const getNetworkDiagnostics = () => ({
  platform: Platform.OS,
  version: Platform.Version,
  isHermes: typeof HermesInternal === 'object'
});
```

### 3. iOS ATS 보안 정책 설정 (`app.json`)
```json
"ios": {
  "infoPlist": {
    "NSAppTransportSecurity": {
      "NSAllowsArbitraryLoads": true,
      "NSAllowsLocalNetworking": true,
      "NSExceptionDomains": {
        "192.168.219.141": {
          "NSExceptionAllowsInsecureHTTPLoads": true,
          "NSExceptionMinimumTLSVersion": "1.0"
        }
      }
    }
  }
}
```

### 4. Android 네트워크 권한 설정
```json
"android": {
  "usesCleartextTraffic": true,
  "permissions": ["INTERNET", "ACCESS_NETWORK_STATE"]
}
```

### 5. 백엔드 CORS 설정 업데이트 (`SAJU/backend/app/main.py`)
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",
        "http://localhost:4000", 
        "http://192.168.219.141:8000",
        "*"  # 모바일 개발 중 모든 origins 허용
    ]
)
```

### 6. 백엔드 서버 네트워크 바인딩
```bash
# 모든 네트워크 인터페이스에서 접근 가능
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

## 🧪 테스트 결과

### 백엔드 API 테스트 (성공 ✅)
```bash
curl -X GET "http://192.168.219.141:8000/api/v1/saju/test"
# 응답: {"message":"새로운 사주 API가 정상 작동중입니다! 🚀"}

curl -X GET "http://192.168.219.141:8000/health"  
# 응답: {"status":"healthy"}
```

### 모바일 앱 테스트 (실패 ❌)
- **플랫폼**: iOS 시뮬레이터 (iOS 18.6, Hermes)
- **API URL**: `http://192.168.219.141:8000/api/v1/saju/analyze`
- **에러**: Network request failed → AbortError (30초 타임아웃)

## 🚧 현재 잔존 문제

### iOS 시뮬레이터 네트워크 접근 제한
1. **iOS 시뮬레이터 → Windows 호스트 머신** 네트워크 접근 차단
2. **가능한 원인들**:
   - Windows 방화벽 정책
   - Xcode 시뮬레이터 네트워크 샌드박스
   - Expo Go 앱의 네트워크 권한 제한
   - 네트워크 라우팅 설정

## 🔄 추가 시도 가능한 해결책

### 1. Expo Tunnel 모드 사용
```bash
expo start --tunnel
# Expo 터널을 통한 외부 접근 가능한 URL 생성
```

### 2. ngrok 터널링
```bash
ngrok http 8000
# 공개 HTTPS URL을 통한 백엔드 노출
```

### 3. 실제 iOS 기기 테스트
- iOS 시뮬레이터 대신 실제 모바일 기기에서 테스트
- 동일한 WiFi 네트워크에서 직접 접근

### 4. 안드로이드 에뮬레이터 테스트
```typescript
// Android 에뮬레이터용 설정
if (Platform.OS === 'android') {
  return 'http://10.0.2.2:8000'; // Android 에뮬레이터의 특수 IP
}
```

## 📊 현재 서비스 상태

| 서비스 | URL | 상태 |
|--------|-----|------|
| Main App | http://localhost:4000 | ✅ 정상 |
| SAJU Web | http://localhost:3000 | ✅ 정상 |
| SAJU API | http://192.168.219.141:8000 | ✅ 정상 |
| Mobile App | iOS 시뮬레이터 | ❌ 네트워크 연결 실패 |

## 🎯 다음 단계

1. **모바일 네트워크 이슈 해결** (일시 보류)
   - Expo tunnel 모드 또는 ngrok 시도
   - 실제 기기에서 테스트

2. **주요 개발 과제 진행**
   - 궁합운 점수 극단화 시스템 구현
   - 사주 분석 25개 확장 기능 Phase 1

## 💡 학습 사항

1. **모바일 개발 네트워크 복잡성**
   - iOS/Android 각각 다른 네트워크 접근 방식
   - ATS, cleartext traffic 등 보안 정책 고려 필요

2. **Expo 개발 환경의 제약**
   - 시뮬레이터 환경에서의 네트워크 제한
   - 터널링이나 실제 기기 테스트의 중요성

3. **백엔드-모바일 연동 고려사항**
   - CORS 설정의 중요성
   - 네트워크 바인딩 설정 (0.0.0.0 vs 127.0.0.1)